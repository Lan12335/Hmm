#include <RF24.h>
#include <nRF24L01.h>
#include <SPI.h>
#include <Wire.h>
#include <SD.h>
#include <Time.h>
#include <DS1307RTC.h>

#define SDPower 3  
#define NrfCS 7
#define SdCS 10

int F1;
int F2;
int F3;

File myFile;

RF24 radio(8, NrfCS); // CE, CSN pins

const byte address[][6] = {"1Node", "2Node"};

void setup() {
  Serial.begin(9600);

  pinMode(SDPower, OUTPUT);
  pinMode(NrfCS, OUTPUT);
  pinMode(SdCS, OUTPUT); 
  
  digitalWrite(SDPower, HIGH); // Start with SD card power OFF (MOSFET gate HIGH)
  digitalWrite(NrfCS, HIGH);
  digitalWrite(SdCS, HIGH);

  NRF24();
  SDop();

  if(RTC.chipPresent()) {
    Serial.println("RTC good");
  }

  else if(!RTC.chipPresent()) {
    Serial.println("RTC no good");
    while(1);
  }
}

void NRF24() {
  NRF24act();
  if(radio.begin()) {
    Serial.println("radio good");
    radio.setPALevel(RF24_PA_LOW);
    radio.openWritingPipe(address[0]);  // This node writes to address 0
    radio.openReadingPipe(1, address[1]); // This node reads from address 1
  }
  if(!radio.begin()) {
    Serial.println("radio no good");
    while(1);
  }
  NRF24dea();
}

void SDop() {
  SDact();
  if(SD.begin(10)) {
    Serial.println("SD good");

    if(SD.exists("experi.txt")) {
      SD.remove("experi.txt");
      Serial.println("file has been overwritten");
    }

    myFile = SD.open("experi.txt", FILE_WRITE);

    if(myFile) {
      Serial.print("writing to experi.txt: ");
      myFile.println("Time,Day,1,2,3");

      myFile.close();
    }

    else{
      Serial.println("SDmanage header PPPP")
    }
  }

  else if(!SD.begin(10)) {
    Serial.println("SD no good");
    while(1);
  }
}

void loop() {
  F1=analogRead(A0);
  F2=analogRead(A1);
  F3=analogRead(A2);

  RTCFSSD();

  Sending 
}

void RTCFSSD() {
  tmElements_t tm;

  if(RTC.read(tm)) {
    Serial.prinln("Writing...");
    Serial.println(tm.Second);

    myFile = SD.open("experi.txt", FILE_WRITE);

    if(myFile) {
      Serial.println("Writing na po");

      myFile.println("Time: ");
      myFile.print((tm.Hour));
      myFile.print(":");
      myFile.print((tm.Minute));
      myFile.print(":");
      myFile.print((tm.Second));
      myFile.print("Day(DMY): ");
      myFile.print(tm.Day);
      myFile.print("/");
      myFile.print(tm.Month);

      myFile.print(" pos: ");
      myFile.print(F1);
      myFile.print(",");
      myFile.print(F2);
      myFile.print(",");
      myFile.print(F3);

      myFile.close();

      Serial.println("Done");
    }
  }

  else{
    Serial.println("error in RTCFSSD");
  }
}

void SDact() {
  delay(100);
  digitalWrite(NrfCS, HIGH);
  digitalWrite(SDPower, LOW);
  digitalWrite(SdCS, LOW);
}

void SDdea() {
  delay(100);
  digitalWrite(NrfCS, HIGH);
  digitalWrite(SDPower, HIGH);
  digitalWrite(SdCS, HIGH);
}

void NRF24act() {
  delay(100);
  digitalWrite(SDPower, HIGH);
  digitalWrite(SdCS, HIGH);
  digitalWrite(NrfCS, LOW);
}

void NRF24dea() {
  delay(100);
  digitalWrite(SDPower, HIGH);
  digitalWrite(SdCS, HIGH);
  digitalWrite(NrfCS, HIGH);
}
